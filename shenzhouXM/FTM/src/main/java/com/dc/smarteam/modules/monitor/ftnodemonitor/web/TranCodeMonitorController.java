package com.dc.smarteam.modules.monitor.ftnodemonitor.web;import com.dc.smarteam.common.persistence.Page;import com.dc.smarteam.common.utils.StringUtils;import com.dc.smarteam.common.web.BaseController;import com.dc.smarteam.helper.PageHelper;import com.dc.smarteam.modules.file.entity.BizFileDownloadLog;import com.dc.smarteam.modules.file.entity.BizFileUploadLog;import com.dc.smarteam.modules.file.service.BizFileDownloadLogService;import com.dc.smarteam.modules.file.service.BizFileUploadLogService;import com.dc.smarteam.modules.monitor.ftnodemonitor.entity.TranCodeMonitor;import com.dc.smarteam.modules.serviceinfo.entity.FtServiceInfo;import com.dc.smarteam.service.ServiceInfoService;import org.apache.shiro.authz.annotation.RequiresPermissions;import org.springframework.stereotype.Controller;import org.springframework.ui.Model;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.servlet.mvc.support.RedirectAttributes;import javax.annotation.Resource;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;import java.util.ArrayList;import java.util.HashMap;import java.util.List;import java.util.Map;/** * 交易码动态，展示交易码最近使用时间等信息 * Created by Administrator on 2017/8/26. */@Controller@RequestMapping(value = "${adminPath}/monitor/FtNodeMonitor/trancodemonitor")public class TranCodeMonitorController extends BaseController {    @Resource    private ServiceInfoService serviceInfoService;    @Resource    private BizFileUploadLogService bizFileUploadLogService;    @Resource    private BizFileDownloadLogService bizFileDownloadLogService;    @RequiresPermissions("NodeMonitor:tranCodeMonitor:view")    @RequestMapping(value = "{trancodelist}")    public String list(TranCodeMonitor tranCodeMonitor, HttpServletRequest request, HttpServletResponse response, Model model, RedirectAttributes redirectAttributes) {// NOSONAR        List<FtServiceInfo> ftServiceInfoList = serviceInfoService.getFtServiceInfoList();        model.addAttribute("ftServiceInfoList", ftServiceInfoList);        List<TranCodeMonitor> tranCodeMonitorList = new ArrayList<>();        //根据交易码查询        if (StringUtils.isNotEmpty(tranCodeMonitor.getTranCode())) {            String tranCode = tranCodeMonitor.getTranCode();            TranCodeMonitor tranCodeMonitorTmp = new TranCodeMonitor();            for (FtServiceInfo ftServiceInfo : ftServiceInfoList) {                if (StringUtils.equals(ftServiceInfo.getTrancode(), tranCode)) {                    tranCodeMonitorTmp.setTranCode(tranCode);                    tranCodeMonitorTmp.setDescribe(ftServiceInfo.getDescribe());                    Map<String, String> map = new HashMap<>();                    map.put("tranCode", tranCodeMonitor.getTranCode());                    tranCodeMonitorTmp = findListFromUpAndDown(tranCodeMonitorTmp, map);                    tranCodeMonitorList.add(tranCodeMonitorTmp);                    PageHelper.getInstance().getPage(TranCodeMonitor.class, request, response, model, tranCodeMonitorList);                    return "modules/monitor/nodeMonitor/TranCodeMonitor";                }            }        }        //分页查询        Page<TranCodeMonitor> page = new Page<>(request, response);        int pageNoIndex = page.getPageNo();        int pageSize = page.getPageSize();        page.setCount(ftServiceInfoList.size());        for (int i = (pageNoIndex - 1) * pageSize; i < pageNoIndex * pageSize; i++) {            if (i == ftServiceInfoList.size()) break;            TranCodeMonitor tranCodeMonitorTmp = new TranCodeMonitor();            tranCodeMonitorTmp.setDescribe(ftServiceInfoList.get(i).getDescribe());            tranCodeMonitorTmp.setTranCode(ftServiceInfoList.get(i).getTrancode());            Map<String, String> map = new HashMap<>();            map.put("tranCode", ftServiceInfoList.get(i).getTrancode());            tranCodeMonitorTmp = findListFromUpAndDown(tranCodeMonitorTmp, map);            tranCodeMonitorList.add(tranCodeMonitorTmp);        }        page.setList(tranCodeMonitorList);        model.addAttribute("page", page);        return "modules/monitor/nodeMonitor/TranCodeMonitor";    }    /**     * 从上传流水表、下载流水表中，找到该交易码的信息     */    private TranCodeMonitor findListFromUpAndDown(TranCodeMonitor tranCodeMonitor, Map<String, String> map) {        List<BizFileUploadLog> uploadLogList = bizFileUploadLogService.findListByTranCodeAndFileName(map);        if (!uploadLogList.isEmpty()) {            tranCodeMonitor.setOriFilename(uploadLogList.get(0).getOriFileName());            tranCodeMonitor.setUploadTime(uploadLogList.get(0).getStartTime());            tranCodeMonitor.setFileName(uploadLogList.get(0).getFileName());        }        List<BizFileDownloadLog> downloadLogList = bizFileDownloadLogService.findListByTranCodeAndFileName(map);        if (!downloadLogList.isEmpty()) {            tranCodeMonitor.setDownloadTime(downloadLogList.get(0).getStartTime());        }        return tranCodeMonitor;    }}